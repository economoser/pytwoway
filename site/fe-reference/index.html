<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<title>fe_approximate_correction_full - PyTwoWay Documentation</title>
<link href="../css/bootstrap.min.css" rel="stylesheet"/>
<link href="../css/font-awesome.min.css" rel="stylesheet"/>
<link href="../css/base.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet"/>
<script defer="" src="../js/jquery-1.10.2.min.js"></script>
<script defer="" src="../js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
<div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
<div class="container">
<a class="navbar-brand" href="..">PyTwoWay Documentation</a>
<!-- Expander button -->
<button class="navbar-toggler" data-target="#navbar-collapse" data-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<!-- Expanded navigation -->
<div class="navbar-collapse collapse" id="navbar-collapse">
<!-- Main navigation -->
<ul class="nav navbar-nav">
<li class="navitem">
<a class="nav-link" href="..">Home</a>
</li>
<li class="navitem">
<a class="nav-link" href="../twfe_network-reference/">twfe_network</a>
</li>
<li class="navitem active">
<a class="nav-link" href="./">fe_approximate_correction_full</a>
</li>
</ul>
<ul class="nav navbar-nav ml-auto">
<li class="nav-item">
<a class="nav-link" data-target="#mkdocs_search_modal" data-toggle="modal" href="#">
<i class="fa fa-search"></i> Search
                            </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../twfe_network-reference/" rel="prev">
<i class="fa fa-arrow-left"></i> Previous
                                </a>
</li>
<li class="nav-item">
<a class="nav-link disabled" rel="next">
                                    Next <i class="fa fa-arrow-right"></i>
</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container">
<div class="row">
<div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
<div class="navbar-header">
<button class="navbar-toggler collapsed" data-target="#toc-collapse" data-toggle="collapse" title="Table of Contents" type="button">
<span class="fa fa-angle-down"></span>
</button>
</div>
<div class="navbar-collapse collapse card bg-secondary" id="toc-collapse">
<ul class="nav flex-column">
<li class="nav-item" data-level="1"><a class="nav-link" href="#fe_approximate_correction_full-module">fe_approximate_correction_full module</a>
<ul class="nav flex-column">
<li class="nav-item" data-level="2"><a class="nav-link" href="#fe_approximate_correction_full">fe_approximate_correction_full</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#fe_approximate_correction_full.FEsolver">FEsolver</a>
<ul class="nav flex-column">
</ul>
</li>
</ul>
</li>
<li class="nav-item" data-level="1"><a class="nav-link" href="#fixme-i-think-delete-everything-below-this-its-basically-contained-in-the-classfunctions-within-the-class">FIXME I think delete everything below this, it's basically contained in the class/functions within the class</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="1"><a class="nav-link" href="#fixme-i-dont-know-what-this-function-does-so-i-dont-know-what-pii-is">FIXME I don't know what this function does, so I don't know what Pii is</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="1"><a class="nav-link" href="#fixme-i-dont-know-what-this-is">FIXME I don't know what this is</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="1"><a class="nav-link" href="#fixme-i-dont-know-what-this-is">FIXME I don't know what this is</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="1"><a class="nav-link" href="#fixme-i-dont-know-what-this-is">FIXME I don't know what this is</a>
<ul class="nav flex-column">
</ul>
</li>
</ul>
</div>
</div></div>
<div class="col-md-9" role="main">
<h1 id="fe_approximate_correction_full-module">fe_approximate_correction_full module</h1>
<div class="doc doc-object doc-module">
<h2 class="hidden-toc" href="#fe_approximate_correction_full" id="fe_approximate_correction_full" style="visibility: hidden; position: absolute;">
</h2>
<div class="doc doc-contents first">
<p>Computes a bunch of estimates from an event study data set:
    - AKM variance decomposition
    - Andrews bias correction
    - KSS bias correction
Does this through class FEsolver</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver">
<code>FEsolver</code>
</h2>
<div class="doc doc-contents">
<p>Uses multigrid and partialing out to solve two way Fixed Effect model</p>
<h1 id="fixme-i-think-delete-everything-below-this-its-basically-contained-in-the-classfunctions-within-the-class">FIXME I think delete everything below this, it's basically contained in the class/functions within the class</h1>
<p>takes as an input this adata
and creates associated A = [J W] matrix which are AKM dummies</p>
<p>provides methods to do A x Y but also (A'A)^-1 A'Y solve method</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.__getstate__">
<code class="highlight language-python">
__getstate__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Defines how the model is pickled</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Nothing</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Defines how the model is pickled</span>

<span class="sd">    Arguments:</span>
<span class="sd">        Nothing</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    '''</span>
    <span class="n">odict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">-</span> <span class="p">{</span><span class="s1">'ml'</span><span class="p">}}</span>
    <span class="k">return</span> <span class="n">odict</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.__init__">
<code class="highlight language-python">
__init__<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Initialize FEsolver object</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>params</code></td>
<td><code>dictionary</code></td>
<td>
<p>dictionary of parameters
data (Pandas DataFrame): labor data. Contains the following columns:
    wid (worker id)
    y1 (compensation 1)
    y2 (compensation 2)
    f1i (firm id 1)
    f2i (firm id 2)
    m (0 if stayer, 1 if mover)
ncore (int): number of cores to use
ndraw_pii (int): number of draws to compute leverage
ndraw_tr (int): number of draws to compute heteroskedastic correction
hetero (bool): if True, compute heteroskedastic correction
statsonly (bool): if True, return only basic statistics
out (string): if statsonly is True, this is the file where the statistics will be saved
batch (): #FIXME I don't know what this is</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Object of type FEsolver</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Initialize FEsolver object</span>

<span class="sd">    Arguments:</span>
<span class="sd">        params (dictionary): dictionary of parameters</span>
<span class="sd">            data (Pandas DataFrame): labor data. Contains the following columns:</span>
<span class="sd">                wid (worker id)</span>
<span class="sd">                y1 (compensation 1)</span>
<span class="sd">                y2 (compensation 2)</span>
<span class="sd">                f1i (firm id 1)</span>
<span class="sd">                f2i (firm id 2)</span>
<span class="sd">                m (0 if stayer, 1 if mover)</span>
<span class="sd">            ncore (int): number of cores to use</span>
<span class="sd">            ndraw_pii (int): number of draws to compute leverage</span>
<span class="sd">            ndraw_tr (int): number of draws to compute heteroskedastic correction</span>
<span class="sd">            hetero (bool): if True, compute heteroskedastic correction</span>
<span class="sd">            statsonly (bool): if True, return only basic statistics</span>
<span class="sd">            out (string): if statsonly is True, this is the file where the statistics will be saved</span>
<span class="sd">            batch (): #FIXME I don't know what this is</span>

<span class="sd">    Returns:</span>
<span class="sd">        Object of type FEsolver</span>
<span class="sd">    '''</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Results dictionary</span>

    <span class="c1"># Save some commonly used parameters as attributes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ncore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'ncore'</span><span class="p">]</span> <span class="c1"># number of cores to use</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ndraw_pii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'ndraw_pii'</span><span class="p">]</span> <span class="c1"># number of draws to compute leverage</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ndraw_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'ndraw_tr'</span><span class="p">]</span> <span class="c1"># number of draws to compute hetero correction</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compute_hetero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'hetero'</span><span class="p">]</span>

    <span class="c1"># Store some parameters in results dictionary</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'cores'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncore</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'ndp'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndraw_pii</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'ndt'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndraw_trace</span>

    <span class="c1"># Begin cleaning and analysis</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prep_data</span><span class="p">()</span> <span class="c1"># Prepare data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init_prepped_adata</span><span class="p">()</span> <span class="c1"># Use cleaned adata to generate some attributes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compute_early_stats</span><span class="p">()</span> <span class="c1"># Use cleaned data to compute some statistics</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'statsonly'</span><span class="p">]:</span> <span class="c1"># If only returning early statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_early_stats</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># If running analysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_fe_solver</span><span class="p">()</span> <span class="c1"># Solve FE model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_trace_approximation_fe</span><span class="p">()</span> <span class="c1"># Compute trace approxmation</span>

        <span class="c1"># If computing heteroskedastic correction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_hetero</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_leverages_Pii</span><span class="p">()</span> <span class="c1"># Solve he model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_trace_approximation_he</span><span class="p">()</span> <span class="c1"># Compute trace approximation</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collect_res</span><span class="p">()</span> <span class="c1"># Collect all results</span>

    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'total_time'</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">save_res</span><span class="p">()</span> <span class="c1"># Save results to json</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'------ DONE -------'</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.__setstate__">
<code class="highlight language-python">
__setstate__<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Defines how the model is unpickled</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>d</code></td>
<td><code>dictionary</code></td>
<td>
<p>attribute dictionary</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Nothing</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Defines how the model is unpickled</span>

<span class="sd">    Arguments:</span>
<span class="sd">        d (dictionary): attribute dictionary</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    '''</span>
    <span class="c1"># Need to recreate the simple model and the search representation</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">d</span> <span class="c1"># Make d the attribute dictionary</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ml</span> <span class="o">=</span> <span class="n">pyamg</span><span class="o">.</span><span class="n">ruge_stuben_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.collect_res">
<code class="highlight language-python">
collect_res<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Collect all results</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Nothing</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">collect_res</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Collect all results</span>

<span class="sd">    Arguments:</span>
<span class="sd">        Nothing</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    '''</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tot_var'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_var</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'eps_var_ho'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_e</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'eps_var_fe'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_var_ho'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_var_ho_all</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_cov_ho'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_cov_ho_all</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[ho] VAR tr=</span><span class="si">{:2.4f}</span><span class="s1"> (sd=</span><span class="si">{:2.4e}</span><span class="s1">)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_var_ho'</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_var_ho_all</span><span class="p">)))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[ho] COV tr=</span><span class="si">{:2.4f}</span><span class="s1"> (sd=</span><span class="si">{:2.4e}</span><span class="s1">)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_cov_ho'</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_cov_ho_all</span><span class="p">)))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_hetero</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'eps_var_he'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sii</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'min_lev'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">'m == 1'</span><span class="p">)</span><span class="o">.</span><span class="n">Pii</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'max_lev'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">'m == 1'</span><span class="p">)</span><span class="o">.</span><span class="n">Pii</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_var_he'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_var_he_all</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_cov_he'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_cov_he_all</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_var_ho_sd'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_var_ho_all</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_cov_ho_sd'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_cov_ho_all</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_var_he_sd'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_var_he_all</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_cov_he_sd'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_cov_he_all</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[he] VAR tr=</span><span class="si">{:2.4f}</span><span class="s1"> (sd=</span><span class="si">{:2.4e}</span><span class="s1">)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_var_he'</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_var_he_all</span><span class="p">)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[he] COV tr=</span><span class="si">{:2.4f}</span><span class="s1"> (sd=</span><span class="si">{:2.4e}</span><span class="s1">)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_cov_he'</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_cov_he_all</span><span class="p">)))</span>

    <span class="c1"># ----- FINAL ------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[ho] VAR fe=</span><span class="si">{:2.4f}</span><span class="s1"> bc=</span><span class="si">{:2.4f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_fe</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_e</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_var_ho'</span><span class="p">]))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[ho] COV fe=</span><span class="si">{:2.4f}</span><span class="s1"> bc=</span><span class="si">{:2.4f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_fe</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_e</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_cov_ho'</span><span class="p">]))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_hetero</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[he] VAR fe=</span><span class="si">{:2.4f}</span><span class="s1"> bc=</span><span class="si">{:2.4f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_fe</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_var_he'</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[he] COV fe=</span><span class="si">{:2.4f}</span><span class="s1"> bc=</span><span class="si">{:2.4f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_fe</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_cov_he'</span><span class="p">]))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'var_y'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Yq</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'var_fe'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_fe</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'cov_fe'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_fe</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'var_ho'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_fe</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_e</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_var_ho'</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'cov_ho'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_fe</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_e</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_cov_ho'</span><span class="p">]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_hetero</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'var_he'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_fe</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_var_he'</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'cov_he'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_fe</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'tr_cov_he'</span><span class="p">]</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.compute_early_stats">
<code class="highlight language-python">
compute_early_stats<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Compute some early statistics</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Nothing</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">compute_early_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Compute some early statistics</span>

<span class="sd">    Arguments:</span>
<span class="sd">        Nothing</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    '''</span>
    <span class="n">fdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'f1i'</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">'m'</span><span class="p">:</span><span class="s1">'sum'</span><span class="p">,</span> <span class="s1">'y1'</span><span class="p">:</span><span class="s1">'mean'</span><span class="p">,</span> <span class="s1">'wid'</span><span class="p">:</span><span class="s1">'count'</span> <span class="p">})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'mover_quantiles'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted_quantile</span><span class="p">(</span><span class="n">fdata</span><span class="p">[</span><span class="s1">'m'</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">fdata</span><span class="p">[</span><span class="s1">'wid'</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'size_quantiles'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted_quantile</span><span class="p">(</span><span class="n">fdata</span><span class="p">[</span><span class="s1">'wid'</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">fdata</span><span class="p">[</span><span class="s1">'wid'</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'between_firm_var'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted_var</span><span class="p">(</span><span class="n">fdata</span><span class="p">[</span><span class="s1">'y1'</span><span class="p">],</span> <span class="n">fdata</span><span class="p">[</span><span class="s1">'wid'</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'var_y'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">[</span><span class="s1">'cs'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">][</span><span class="s1">'y1'</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="c1"># FIXME changed from adata.query('cs==1') (I ran %timeit and slicing is faster)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.compute_leverages_Pii">
<code class="highlight language-python">
compute_leverages_Pii<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Compute leverages for heteroskedastic correction</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Nothing</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">compute_leverages_Pii</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Compute leverages for heteroskedastic correction</span>

<span class="sd">    Arguments:</span>
<span class="sd">        Nothing</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    '''</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Pii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Sii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'levfile'</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[he] starting heteroskedastic correction, loading precomputed files'</span><span class="p">)</span>

        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">'</span><span class="si">{}</span><span class="s1">*'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'levfile'</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[he] found </span><span class="si">{}</span><span class="s1"> files to get leverages from'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'lev_file_count'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"Didn't find any leverage files!"</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Pii</span> <span class="o">+=</span> <span class="n">pp</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncore</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[he] starting heteroskedastic correction p2=</span><span class="si">{}</span><span class="s1">, using </span><span class="si">{}</span><span class="s1"> cores, batch size </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndraw_pii</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncore</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'batch'</span><span class="p">]))</span>
        <span class="n">set_start_method</span><span class="p">(</span><span class="s1">'spawn'</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ncore</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">Pii_all</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leverage_approx</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'batch'</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndraw_pii</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'batch'</span><span class="p">])])</span>

        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">Pii_all</span><span class="p">:</span>
            <span class="n">Pii</span> <span class="o">+=</span> <span class="n">pp</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">Pii_all</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">Pii_all</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leverage_approx</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'batch'</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndraw_pii</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'batch'</span><span class="p">])]))</span>

        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">Pii_all</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Pii</span> <span class="o">+=</span> <span class="n">pp</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">Pii_all</span><span class="p">)</span>

    <span class="n">I</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">'m == 1'</span><span class="p">)</span>
    <span class="n">max_leverage</span> <span class="o">=</span> <span class="p">(</span><span class="n">I</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pii</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># Attach the computed Pii to the dataframe</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">[</span><span class="s1">'Pii'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pii</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[he] Leverage range </span><span class="si">{:2.4f}</span><span class="s1"> to </span><span class="si">{:2.4f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">'m == 1'</span><span class="p">)</span><span class="o">.</span><span class="n">Pii</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">'m == 1'</span><span class="p">)</span><span class="o">.</span><span class="n">Pii</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

    <span class="c1"># Give stayers the variance estimate at the firm level</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">[</span><span class="s1">'Sii'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pii</span><span class="p">)</span>
    <span class="n">S_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">'m == 1'</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'Sii'</span><span class="p">:</span> <span class="s1">'Sii_j'</span><span class="p">})</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'f1i'</span><span class="p">)[</span><span class="s1">'Sii_j'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'mean'</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">adata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">,</span> <span class="n">S_j</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">'f1i'</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">[</span><span class="s1">'Sii'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">[</span><span class="s1">'m'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">[</span><span class="s1">'Sii'</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">[</span><span class="s1">'Sii_j'</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Sii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">[</span><span class="s1">'Sii'</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[he] variance of residuals in heteroskedastic case: </span><span class="si">{:2.4f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sii</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.compute_trace_approximation_fe">
<code class="highlight language-python">
compute_trace_approximation_fe<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Compute FE trace approximation</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Nothing</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">compute_trace_approximation_fe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Compute FE trace approximation</span>

<span class="sd">    Arguments:</span>
<span class="sd">        Nothing</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    '''</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Starting FE trace correction ndraws=</span><span class="si">{}</span><span class="s1">, using </span><span class="si">{}</span><span class="s1"> cores'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndraw_trace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncore</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tr_var_ho_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndraw_trace</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tr_cov_ho_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndraw_trace</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndraw_trace</span><span class="p">):</span>
        <span class="c1"># Generate -1 or 1</span>
        <span class="n">Zpsi</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">Zalpha</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nw</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">R1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Jq</span> <span class="o">*</span> <span class="n">Zpsi</span>
        <span class="n">psi1</span><span class="p">,</span> <span class="n">alpha1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_AAinv</span><span class="p">(</span><span class="n">Zpsi</span><span class="p">,</span> <span class="n">Zalpha</span><span class="p">)</span>
        <span class="n">R2_psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Jq</span> <span class="o">*</span> <span class="n">psi1</span>
        <span class="n">R2_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wq</span> <span class="o">*</span> <span class="n">alpha1</span>

        <span class="c1"># Trace corrections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr_var_ho_all</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="n">R2_psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr_cov_ho_all</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="n">R2_alpha</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'FE [traces] step </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1"> done.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndraw_trace</span><span class="p">))</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.compute_trace_approximation_he">
<code class="highlight language-python">
compute_trace_approximation_he<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Compute heteroskedastic trace approximation</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Nothing</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">compute_trace_approximation_he</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Compute heteroskedastic trace approximation</span>

<span class="sd">    Arguments:</span>
<span class="sd">        Nothing</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    '''</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Starting he trace correction ndraws=</span><span class="si">{}</span><span class="s1">, using </span><span class="si">{}</span><span class="s1"> cores'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndraw_trace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncore</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tr_var_he_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndraw_trace</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tr_cov_he_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndraw_trace</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndraw_trace</span><span class="p">):</span>
        <span class="n">Zpsi</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">Zalpha</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nw</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">psi1</span><span class="p">,</span> <span class="n">alpha1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_AAinv</span><span class="p">(</span><span class="n">Zpsi</span><span class="p">,</span> <span class="n">Zalpha</span><span class="p">)</span>
        <span class="n">R2_psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Jq</span> <span class="o">*</span> <span class="n">psi1</span>
        <span class="n">R2_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wq</span> <span class="o">*</span> <span class="n">alpha1</span>

        <span class="n">psi2</span><span class="p">,</span> <span class="n">alpha2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_AAinv</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mult_Atranspose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sii</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_A</span><span class="p">(</span><span class="n">Zpsi</span><span class="p">,</span> <span class="n">Zalpha</span><span class="p">)))</span>
        <span class="n">R3_psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Jq</span> <span class="o">*</span> <span class="n">psi2</span>

        <span class="c1"># Trace corrections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr_var_he_all</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">R2_psi</span><span class="p">,</span> <span class="n">R3_psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr_cov_he_all</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">R2_alpha</span><span class="p">,</span> <span class="n">R3_psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'he [traces] step </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1"> done.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndraw_trace</span><span class="p">))</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.create_fe_solver">
<code class="highlight language-python">
create_fe_solver<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Solve FE model</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Nothing</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">create_fe_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Solve FE model</span>

<span class="sd">    Arguments:</span>
<span class="sd">        Nothing</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    '''</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">y1</span>

    <span class="c1"># try to pickle the object to see its size</span>
    <span class="c1"># self.save('tmp.pkl') # FIXME should we delete these 2 lines?</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Extract firm effects'</span><span class="p">)</span>

    <span class="n">psi_hat</span><span class="p">,</span> <span class="n">alpha_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Solver time </span><span class="si">{:2.4f}</span><span class="s1"> seconds'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_invert_time</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Expected total time </span><span class="si">{:2.4f}</span><span class="s1"> minutes'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndraw_trace</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_hetero</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndraw_pii</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_hetero</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_invert_time</span> <span class="o">/</span> <span class="mi">60</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_A</span><span class="p">(</span><span class="n">psi_hat</span><span class="p">,</span> <span class="n">alpha_hat</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'solver_time'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_invert_time</span>

    <span class="n">fe_rsq</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Fixed effect R-square </span><span class="si">{:2.4f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fe_rsq</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">var_fe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Jq</span> <span class="o">*</span> <span class="n">psi_hat</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cov_fe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Jq</span> <span class="o">*</span> <span class="n">psi_hat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wq</span> <span class="o">*</span> <span class="n">alpha_hat</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tot_var</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[fe] var_psi=</span><span class="si">{:2.4f}</span><span class="s1"> cov=</span><span class="si">{:2.4f}</span><span class="s1"> tot=</span><span class="si">{:2.4f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_var</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">var_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nn</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nn</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nw</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[ho] variance of residuals </span><span class="si">{:2.4f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_e</span><span class="p">))</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.init_prepped_adata">
<code class="highlight language-python">
init_prepped_adata<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Use prepped adata to initialize class attributes</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>adata</code></td>
<td><code>Pandas DataFrame</code></td>
<td>
<p>labor data. Contains the following columns:
wid (worker id)
y1 (compensation 1)
y2 (compensation 2)
f1i (firm id 1)
f2i (firm id 2)
m (0 if stayer, 1 if mover)</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Nothing</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">init_prepped_adata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Use prepped adata to initialize class attributes</span>

<span class="sd">    Arguments:</span>
<span class="sd">        adata (Pandas DataFrame): labor data. Contains the following columns:</span>
<span class="sd">            wid (worker id)</span>
<span class="sd">            y1 (compensation 1)</span>
<span class="sd">            y2 (compensation 2)</span>
<span class="sd">            f1i (firm id 1)</span>
<span class="sd">            f2i (firm id 2)</span>
<span class="sd">            m (0 if stayer, 1 if mover)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    '''</span>
    <span class="n">nf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">f1i</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># Number of firms</span>
    <span class="n">nw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">wid</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># Number of workers</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">)</span> <span class="c1"># Number of observations</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">=</span> <span class="n">nf</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nw</span> <span class="o">=</span> <span class="n">nw</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nn</span> <span class="o">=</span> <span class="n">nn</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'data nf:</span><span class="si">{}</span><span class="s1"> nw:</span><span class="si">{}</span><span class="s1"> nn:</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="n">nn</span><span class="p">))</span>

    <span class="c1"># Matrices for the cross-section</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">f1i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span> <span class="c1"># Firms</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">J</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>  <span class="c1"># Normalize one firm to 0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="n">J</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">wid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">nw</span><span class="p">))</span> <span class="c1"># Workers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
    <span class="c1"># Dw = diags((W.T * W).diagonal()) # FIXME changed from .transpose() to .T ALSO commented this out since it's not used</span>
    <span class="n">Dwinv</span> <span class="o">=</span> <span class="n">diags</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()))</span> <span class="c1"># FIXME changed from .transpose() to .T</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Dwinv</span> <span class="o">=</span> <span class="n">Dwinv</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Prepare linear solver'</span><span class="p">)</span>

    <span class="c1"># Finally create M</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">J</span> <span class="o">-</span> <span class="n">J</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">W</span> <span class="o">*</span> <span class="n">Dwinv</span> <span class="o">*</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">J</span> <span class="c1"># FIXME changed from .transpose() to .T</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">M</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ml</span> <span class="o">=</span> <span class="n">pyamg</span><span class="o">.</span><span class="n">ruge_stuben_solver</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

    <span class="c1"># L = diags(fes.M.diagonal()) - fes.M</span>
    <span class="c1"># r = linalg.eigsh(L,k=2,which='LM')</span>

    <span class="c1"># Create cross-section matrices</span>
    <span class="c1"># cs == 1 ==&gt; looking at y1 for movers (cs = cross section)</span>
    <span class="n">mdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">[</span><span class="s1">'cs'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="c1"># FIXME changed from adata.query('cs==1') (I ran %timeit and slicing is faster)</span>
    <span class="n">mdata</span> <span class="o">=</span> <span class="n">mdata</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># FIXME changed from set_index(pd.Series(range(len(mdata))))</span>

    <span class="n">nnq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mdata</span><span class="p">)</span> <span class="c1"># Number of observations</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nnq</span> <span class="o">=</span> <span class="n">nnq</span>
    <span class="n">Jq</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nnq</span><span class="p">),</span> <span class="p">(</span><span class="n">mdata</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mdata</span><span class="o">.</span><span class="n">f1i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nnq</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Jq</span> <span class="o">=</span> <span class="n">Jq</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>  <span class="c1"># normalizing one firm to 0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Wq</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nnq</span><span class="p">),</span> <span class="p">(</span><span class="n">mdata</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mdata</span><span class="o">.</span><span class="n">wid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nnq</span><span class="p">,</span> <span class="n">nw</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Yq</span> <span class="o">=</span> <span class="n">mdata</span><span class="p">[</span><span class="s1">'y1'</span><span class="p">]</span>

    <span class="c1"># Save time variable</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_invert_time</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.leverage_approx">
<code class="highlight language-python">
leverage_approx<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndraw_pii</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Compute an approximate leverage using ndraw_pii</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ndraw_pii</code></td>
<td><code>int</code></td>
<td>
<p>number of draws</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Pii (NumPy Array)</code></td>
<td>
<h1 id="fixme-i-dont-know-what-this-function-does-so-i-dont-know-what-pii-is">FIXME I don't know what this function does, so I don't know what Pii is</h1>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">leverage_approx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndraw_pii</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Compute an approximate leverage using ndraw_pii</span>

<span class="sd">    Arguments:</span>
<span class="sd">        ndraw_pii (int): number of draws</span>

<span class="sd">    Returns:</span>
<span class="sd">        Pii (NumPy Array): # FIXME I don't know what this function does, so I don't know what Pii is</span>
<span class="sd">    '''</span>
    <span class="n">Pii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="p">)</span>

    <span class="c1"># Compute the different draws</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="n">ndraw_pii</span><span class="p">):</span>
        <span class="n">R2</span>  <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">Pii</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">ndraw_pii</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">R2</span><span class="p">),</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Done with batch'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Pii</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.load">
<code class="highlight language-python">
load<span class="p">(</span><span class="n">filename</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Load files for heteroskedastic correction</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>filename</code></td>
<td><code>string</code></td>
<td>
<p>file to load</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fes</code></td>
<td>
<p>loaded file</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Load files for heteroskedastic correction</span>

<span class="sd">    Arguments:</span>
<span class="sd">        filename (string): file to load</span>

<span class="sd">    Returns:</span>
<span class="sd">        fes: loaded file</span>
<span class="sd">    '''</span>
    <span class="n">fes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
        <span class="n">fes</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fes</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.mult_A">
<code class="highlight language-python">
mult_A<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Multiplies A = [J W] stored in the object by psi and alpha (used, for example, to compute estimated outcomes and sample errors)</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>psi</code></td>
<td><code></code></td>
<td>
<p>firm fixed effects # FIXME correct datatype</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>alpha</code></td>
<td><code></code></td>
<td>
<p>worker fixed effects # FIXME correct datatype</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>J_psi + W_alpha (CSC Matrix)</code></td>
<td>
<p>firms * firm fixed effects + workers * worker fixed effects</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">mult_A</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Multiplies A = [J W] stored in the object by psi and alpha (used, for example, to compute estimated outcomes and sample errors)</span>

<span class="sd">    Arguments:</span>
<span class="sd">        psi: firm fixed effects # FIXME correct datatype</span>
<span class="sd">        alpha: worker fixed effects # FIXME correct datatype</span>

<span class="sd">    Returns:</span>
<span class="sd">        J_psi + W_alpha (CSC Matrix): firms * firm fixed effects + workers * worker fixed effects</span>
<span class="sd">    '''</span>
    <span class="c1"># J_psi = self.J * psi</span>
    <span class="c1"># W_alpha = self.W * alpha</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">*</span> <span class="n">psi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">*</span> <span class="n">alpha</span> <span class="c1"># J_psi + W_alpha</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.mult_AAinv">
<code class="highlight language-python">
mult_AAinv<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Multiplies gamma = [psi;alpha] by (A'A)^(-1) where A = [J W] stored in the object</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>psi</code></td>
<td><code></code></td>
<td>
<p>firm fixed effects # FIXME correct datatype</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>alpha</code></td>
<td><code></code></td>
<td>
<p>worker fixed effects # FIXME correct datatype</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>psi_out</code></td>
<td>
<p>estimated firm fixed effects # FIXME correct datatype
alpha_out : estimated worker fixed effects # FIXME correct datatype</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">mult_AAinv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Multiplies gamma = [psi;alpha] by (A'A)^(-1) where A = [J W] stored in the object</span>

<span class="sd">    Arguments:</span>
<span class="sd">        psi: firm fixed effects # FIXME correct datatype</span>
<span class="sd">        alpha: worker fixed effects # FIXME correct datatype</span>

<span class="sd">    Returns:</span>
<span class="sd">        psi_out: estimated firm fixed effects # FIXME correct datatype</span>
<span class="sd">        alpha_out : estimated worker fixed effects # FIXME correct datatype</span>
<span class="sd">    '''</span>
    <span class="c1"># inter1 = self.ml.solve( psi , tol=1e-10 )</span>
    <span class="c1"># inter2 = self.ml.solve(  , tol=1e-10 )</span>
    <span class="c1"># psi_out = inter1 - inter2</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="n">psi_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">psi</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dwinv</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)),</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span> <span class="c1"># FIXME changed from .transpose() to .T</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_invert_time</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="n">alpha_out</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dwinv</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">*</span> <span class="n">psi_out</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dwinv</span> <span class="o">*</span> <span class="n">alpha</span> <span class="c1"># FIXME changed from .transpose() to .T</span>

    <span class="k">return</span> <span class="n">psi_out</span><span class="p">,</span> <span class="n">alpha_out</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.mult_Atranspose">
<code class="highlight language-python">
mult_Atranspose<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Multiplies the transpose of A = [J W] stored in the object by v</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>v</code></td>
<td><code></code></td>
<td>
<p>what to multiply by # FIXME correct datatype</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>J_transpose_V (CSC Matrix)</code></td>
<td>
<p>firms * v
W_transpose_V (CSC Matrix): workers * v</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">mult_Atranspose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Multiplies the transpose of A = [J W] stored in the object by v</span>

<span class="sd">    Arguments:</span>
<span class="sd">        v: what to multiply by # FIXME correct datatype</span>

<span class="sd">    Returns:</span>
<span class="sd">        J_transpose_V (CSC Matrix): firms * v</span>
<span class="sd">        W_transpose_V (CSC Matrix): workers * v</span>
<span class="sd">    '''</span>
    <span class="c1"># J_transpose_V = self.J.T * v # FIXME changed from .transpose() to .T</span>
    <span class="c1"># W_transpose_V = self.W.T * v # FIXME changed from .transpose() to .T</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">v</span> <span class="c1"># J_transpose_V, W_transpose_V</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.prep_data">
<code class="highlight language-python">
prep_data<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Do some initial data cleaning</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Nothing</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">prep_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Do some initial data cleaning</span>

<span class="sd">    Arguments:</span>
<span class="sd">        Nothing</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    '''</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Preparing the data'</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'data'</span><span class="p">]</span>
    <span class="n">sdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">'m'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">jdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">'m'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Data movers=</span><span class="si">{}</span><span class="s1"> stayers=</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jdata</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sdata</span><span class="p">)))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'nm'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jdata</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'ns'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sdata</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'n_firms'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">jdata</span><span class="p">[</span><span class="s1">'f1i'</span><span class="p">],</span> <span class="n">jdata</span><span class="p">[</span><span class="s1">'f2i'</span><span class="p">],</span> <span class="n">sdata</span><span class="p">[</span><span class="s1">'f1i'</span><span class="p">]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'n_workers'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">jdata</span><span class="p">[</span><span class="s1">'wid'</span><span class="p">],</span> <span class="n">sdata</span><span class="p">[</span><span class="s1">'wid'</span><span class="p">]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'n_movers'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">jdata</span><span class="p">[</span><span class="s1">'wid'</span><span class="p">]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
    <span class="c1">#res['year_max'] = int(sdata['year'].max())</span>
    <span class="c1">#res['year_min'] = int(sdata['year'].min())</span>

    <span class="c1"># Make wids unique per row</span>
    <span class="n">jdata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'nm'</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sdata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'ns'</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'nm'</span><span class="p">])</span>
    <span class="n">jdata</span><span class="p">[</span><span class="s1">'wid'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'nm'</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">sdata</span><span class="p">[</span><span class="s1">'wid'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'ns'</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">'nm'</span><span class="p">]</span>

    <span class="c1"># Combine the 2 data-sets</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">adata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">sdata</span><span class="p">[[</span><span class="s1">'wid'</span><span class="p">,</span> <span class="s1">'f1i'</span><span class="p">,</span> <span class="s1">'y1'</span><span class="p">]]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">jdata</span><span class="p">[[</span><span class="s1">'wid'</span><span class="p">,</span> <span class="s1">'f1i'</span><span class="p">,</span> <span class="s1">'y1'</span><span class="p">]]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">jdata</span><span class="p">[[</span><span class="s1">'wid'</span><span class="p">,</span> <span class="s1">'f2i'</span><span class="p">,</span> <span class="s1">'y2'</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'f2i'</span><span class="p">:</span> <span class="s1">'f1i'</span><span class="p">,</span> <span class="s1">'y2'</span><span class="p">:</span> <span class="s1">'y1'</span><span class="p">})</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">adata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># FIXME changed from set_index(pd.Series(range(len(self.adata))))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">[</span><span class="s1">'wid'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adata</span><span class="p">[</span><span class="s1">'wid'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'category'</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.proj">
<code class="highlight language-python">
proj<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Solve y, then project onto X space of data stored in the object</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>y</code></td>
<td><code>Pandas DataFrame</code></td>
<td>
<p>labor data</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Projection of psi, alpha solved from y onto X space</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">proj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> <span class="c1"># FIXME should this y be Y?</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Solve y, then project onto X space of data stored in the object</span>

<span class="sd">    Arguments:</span>
<span class="sd">        y (Pandas DataFrame): labor data</span>

<span class="sd">    Returns:</span>
<span class="sd">        Projection of psi, alpha solved from y onto X space</span>
<span class="sd">    '''</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_A</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.save">
<code class="highlight language-python">
save<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Save FEsolver class to filename as pickle</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>filename</code></td>
<td><code>string</code></td>
<td>
<p>filename to save to</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Nothing</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Save FEsolver class to filename as pickle</span>

<span class="sd">    Arguments:</span>
<span class="sd">        filename (string): filename to save to</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    '''</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.save_early_stats">
<code class="highlight language-python">
save_early_stats<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Save the early statistics computed in compute_early_stats()</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Nothing</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">save_early_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Save the early statistics computed in compute_early_stats()</span>

<span class="sd">    Arguments:</span>
<span class="sd">        Nothing</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    '''</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'out'</span><span class="p">],</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'saved results to </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'out'</span><span class="p">]))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'--statsonly was passed as argument, so we skip all estimation.'</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'------ DONE -------'</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.save_res">
<code class="highlight language-python">
save_res<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Save results as json</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Nothing</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">save_res</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Save results as json</span>

<span class="sd">    Arguments:</span>
<span class="sd">        Nothing</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    '''</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'out'</span><span class="p">],</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Saved results to </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">'out'</span><span class="p">]))</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.solve">
<code class="highlight language-python">
solve<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Compute (A'A)^-1 A'Y, the least squares estimate of A [psi_hat, alpha_hat] = Y</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Y</code></td>
<td><code>Pandas DataFrame</code></td>
<td>
<p>labor data</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>psi_hat</code></td>
<td>
<p>estimated firm fixed effects # FIXME correct datatype
alpha_hat: estimated worker fixed effects # FIXME correct datatype</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Compute (A'A)^-1 A'Y, the least squares estimate of A [psi_hat, alpha_hat] = Y</span>

<span class="sd">    Arguments:</span>
<span class="sd">        Y (Pandas DataFrame): labor data</span>

<span class="sd">    Returns:</span>
<span class="sd">        psi_hat: estimated firm fixed effects # FIXME correct datatype</span>
<span class="sd">        alpha_hat: estimated worker fixed effects # FIXME correct datatype</span>
<span class="sd">    '''</span>
    <span class="n">J_transpose_Y</span><span class="p">,</span> <span class="n">W_transpose_Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_Atranspose</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="c1"># This gives A'Y</span>
    <span class="n">psi_hat</span><span class="p">,</span> <span class="n">alpha_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult_AAinv</span><span class="p">(</span><span class="n">J_transpose_Y</span><span class="p">,</span> <span class="n">W_transpose_Y</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psi_hat</span><span class="p">,</span> <span class="n">alpha_hat</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.weighted_quantile">
<code class="highlight language-python">
weighted_quantile<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">values_sorted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">old_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Very close to numpy.percentile, but supports weights.
    NOTE: quantiles should be in [0, 1]!</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td><code></code></td>
<td>
<p>param values: numpy.array with data</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code></code></td>
<td><code></code></td>
<td>
<p>param quantiles: array-like with many quantiles needed</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code></code></td>
<td><code></code></td>
<td>
<p>param sample_weight: array-like of the same length as <code>array</code></p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code></code></td>
<td><code></code></td>
<td>
<p>param values_sorted: bool, if True, then will avoid sorting of initial array</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code></code></td>
<td><code></code></td>
<td>
<p>param old_style: if True, will correct output to be consistent with numpy.percentile.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>return: numpy.array with computed quantiles.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">weighted_quantile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">values_sorted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">old_style</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># FIXME was formerly a function outside the class</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Very close to numpy.percentile, but supports weights.</span>
<span class="sd">        NOTE: quantiles should be in [0, 1]!</span>

<span class="sd">    Arguments:</span>
<span class="sd">        :param values: numpy.array with data</span>
<span class="sd">        :param quantiles: array-like with many quantiles needed</span>
<span class="sd">        :param sample_weight: array-like of the same length as `array`</span>
<span class="sd">        :param values_sorted: bool, if True, then will avoid sorting of initial array</span>
<span class="sd">        :param old_style: if True, will correct output to be consistent with numpy.percentile.</span>

<span class="sd">    Returns:</span>
<span class="sd">        :return: numpy.array with computed quantiles.</span>
<span class="sd">    '''</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">quantiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">quantiles</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sample_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
    <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">quantiles</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">quantiles</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">),</span> \
        <span class="s1">'quantiles should be in [0, 1]'</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">values_sorted</span><span class="p">:</span>
        <span class="n">sorter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">sorter</span><span class="p">]</span>
        <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">sample_weight</span><span class="p">[</span><span class="n">sorter</span><span class="p">]</span>

    <span class="n">weighted_quantiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sample_weight</span>
    <span class="k">if</span> <span class="n">old_style</span><span class="p">:</span>
        <span class="c1"># To be convenient with numpy.percentile</span>
        <span class="n">weighted_quantiles</span> <span class="o">-=</span> <span class="n">weighted_quantiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">weighted_quantiles</span> <span class="o">/=</span> <span class="n">weighted_quantiles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weighted_quantiles</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">quantiles</span><span class="p">,</span> <span class="n">weighted_quantiles</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h3 class="doc doc-heading" id="fe_approximate_correction_full.FEsolver.weighted_var">
<code class="highlight language-python">
weighted_var<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>!!! purpose
    Compute weighted variance # FIXME I don't know what this function really does</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>v</code></td>
<td><code></code></td>
<td>
<h1 id="fixme-i-dont-know-what-this-is">FIXME I don't know what this is</h1>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>w</code></td>
<td><code></code></td>
<td>
<h1 id="fixme-i-dont-know-what-this-is">FIXME I don't know what this is</h1>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>v0</code></td>
<td>
<h1 id="fixme-i-dont-know-what-this-is">FIXME I don't know what this is</h1>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>pytwoway/fe_approximate_correction_full.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="c1"># FIXME was formerly a function outside the class</span>
    <span class="sd">'''</span>
<span class="sd">    Purpose:</span>
<span class="sd">        Compute weighted variance # FIXME I don't know what this function really does</span>

<span class="sd">    Arguments:</span>
<span class="sd">        v: # FIXME I don't know what this is</span>
<span class="sd">        w: # FIXME I don't know what this is</span>

<span class="sd">    Returns:</span>
<span class="sd">        v0: # FIXME I don't know what this is</span>
<span class="sd">    '''</span>
    <span class="n">m0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">v0</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div></div>
</div>
</div>
<footer class="col-md-12">
<hr/>
<p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
</footer>
<script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
<script defer="" src="../js/base.js"></script>
<script defer="" src="../search/main.js"></script>
<div aria-hidden="true" aria-labelledby="searchModalLabel" class="modal" id="mkdocs_search_modal" role="dialog" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="searchModalLabel">Search</h4>
<button class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
</div>
<div class="modal-body">
<p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
<form>
<div class="form-group">
<input class="form-control" id="mkdocs-search-query" placeholder="Search..." title="Type search term here" type="search"/>
</div>
</form>
<div id="mkdocs-search-results"></div>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div><div aria-hidden="true" aria-labelledby="keyboardModalLabel" class="modal" id="mkdocs_keyboard_modal" role="dialog" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
<button class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
</div>
<div class="modal-body">
<table class="table">
<thead>
<tr>
<th style="width: 20%;">Keys</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="help shortcut"><kbd>?</kbd></td>
<td>Open this help</td>
</tr>
<tr>
<td class="next shortcut"><kbd>n</kbd></td>
<td>Next page</td>
</tr>
<tr>
<td class="prev shortcut"><kbd>p</kbd></td>
<td>Previous page</td>
</tr>
<tr>
<td class="search shortcut"><kbd>s</kbd></td>
<td>Search</td>
</tr>
</tbody>
</table>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div>
</body>
</html>
